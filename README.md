# MassEmail.Net

Объясню как реализовал решения на след. требования:
A. Гарантированная отправка (сервис по отправке ответил, что сообщение отправлено)
B. Отправка должна быть гарантированно ОДНА.
C. Так как адресов много, нужно реализовать многопоточную отправку
D. Нужно предусмотреть отключение электричества. Имеется в виду, что после 
восстановления работоспособности сервиса, рассылка должна продолжиться, не 
нарушив требования.

Для работы службы использую брокер сообщений: RabbitMQ

A. Гарантированная отправка (сервис по отправке ответил, что сообщение отправлено)
Решение: В RabbitMQ есть механизм подтверждения потребителем. Подтверждение отправляется обратно потребителем, чтобы сообщить RabbitMQ, что конкретное сообщение было получено, обработано и что RabbitMQ может удалить его. В настройках указал - autoAck: false

B. Отправка должна быть гарантированно ОДНА.
Решение: этот пункт связан с пунктом А. При отправке письма на email, этого email уже не будет в очереди => повторно отправить не сможем. Конечно надо уточнить предварительно нет ли в очереди дубликатов, а если есть, то разобраться с ними.

C. Так как адресов много, нужно реализовать многопоточную отправку
Решение: Вариантов реализаций есть несколько. Я предложил создать Потребителя (Consumer)  в отдельном проекте и запустить его несколько экземпляров.

D. Нужно предусмотреть отключение электричества. Имеется в виду, что после 
восстановления работоспособности сервиса, рассылка должна продолжиться, не 
нарушив требования.
Решение: В RabbitMQ есть механизм сохранения сообщений на диске даже при аварйином завершении работы. При объявлении очереди помечаю ее как "надежную" - durable: true, а также сообщения как "постоянные" - properties.Persistent = true;

Логика работы службы следующая:
1. Из хранилища(База данных, excel файл и т.д) получил список адресов эл. почты
2. Загрузил список адресов эл. почты в брокер сообщений (в данном случае Rabbit MQ)
3. Из очереди "CommonQueue" получаю адреса и отправляю письма.
4.Если отправка прошла успешно, то убираем из очереди адрес эл. почты.